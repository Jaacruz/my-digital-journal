<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergent Digital Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The application is designed as a Single Page Application (SPA) with two primary views: a 'Calendar View' for high-level navigation and a 'Journal View' for detailed content entry. This structure was chosen to provide a clean, focused user experience. Users start with an overview of their month, can easily select a day, and then "zoom in" to a dedicated writing space. The Journal View is designed to look like an open book, with a CSS page-turning effect for navigating between days, enhancing the journaling theme. A modal is used for adding media to keep the main journal interface uncluttered. This flow from overview to detail is intuitive and mirrors the physical process of finding a page in a diary. -->
    <!-- Visualization & Content Choices: The source 'report' is the prompt describing the app's features. Each feature is implemented with a specific goal and presentation method. 1) Feature: Daily Schedule -> Goal: Navigate entries -> Presentation: Interactive Calendar Grid -> Interaction: Click day to open -> Justification: Familiar and intuitive for a daily journal -> Method: JS/Tailwind. 2) Feature: Journal Entry -> Goal: Capture user thoughts -> Presentation: Two-page book layout -> Interaction: Form inputs, save button -> Justification: Creates an immersive, book-like experience -> Method: HTML/Tailwind. 3) Feature: English Learning -> Goal: Practice tenses -> Presentation: Dedicated section with three text areas -> Interaction: Text input -> Justification: Organizes learning content separately from the main journal entry for focused practice -> Method: HTML/Tailwind. 4) Feature: Multimedia -> Goal: Enrich entries -> Presentation: Inputs in a modal, content displayed in entry -> Justification: Keeps primary UI clean -> Method: JS/HTML. 5) Feature: Drawing/Sketching -> Goal: Express ideas visually -> Presentation: HTML Canvas with drawing tools -> Interaction: Mouse/touch events to draw -> Justification: Aligns with the "Paper" app concept, adds a creative dimension to journaling. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8; /* Warm off-white */
            color: #4a4a4a;
            transition: background-color 0.3s, color 0.3s;
        }
        .book {
            transform-style: preserve-3d;
            perspective: 1500px;
        }
        .page-flipper {
            transition: transform 0.8s;
            transform-style: preserve-3d;
            transform-origin: left center;
        }
        .page-flipper.flipped {
            transform: rotateY(-180deg);
        }
        .page-front, .page-back {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .page-back {
            transform: rotateY(180deg);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.5rem;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .spotify-embed {
            border-radius: 12px;
            height: 80px;
        }
        canvas {
            touch-action: none; /* Prevents default touch gestures like scrolling */
        }
        .category-block {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
        }
        .modal {
            display: none;
        }
        .color-picker-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
                <h1 class="text-3xl md:text-4xl font-bold text-stone-700">Emergent</h1>
                <span id="user-name" class="text-3xl md:text-4xl font-bold text-stone-700"></span>
                <div id="user-info" class="text-sm text-stone-500 bg-stone-100 px-3 py-1 rounded-full hidden">
                    <span class="font-semibold">User ID:</span> <span id="user-id"></span>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="info-btn" class="p-2 rounded-full hover:bg-stone-100 transition"><i class="fas fa-info-circle text-stone-600"></i></button>
                <button id="settings-btn" class="p-2 rounded-full hover:bg-stone-100 transition"><i class="fas fa-cog text-stone-600"></i></button>
            </div>
        </header>

        <!-- Calendar View -->
        <main id="calendar-view" class="">
            <div class="bg-white rounded-lg shadow-lg p-6 border border-stone-200">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-stone-100 transition"><i class="fas fa-chevron-left text-stone-600"></i></button>
                    <h2 id="month-year-header" class="text-xl md:text-2xl font-semibold text-stone-800"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-stone-100 transition"><i class="fas fa-chevron-right text-stone-600"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center font-medium text-stone-500 mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            <div id="hobbies-list-container" class="w-full text-left mt-8 bg-white p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-2xl font-semibold mb-2">My Favorite Things:</h2>
                <ul id="hobbies-list" class="list-disc list-inside space-y-1">
                    <!-- Hobbies will be dynamically added here -->
                </ul>
            </div>
        </main>

        <!-- Journal View -->
        <section id="journal-view" class="hidden">
            <div class="book w-full h-[80vh] relative">
                <!-- Left Static Page -->
                <div class="page-left w-1/2 h-full absolute left-0 top-0 bg-white shadow-xl rounded-l-lg p-6 flex flex-col border-r border-stone-200">
                    <div class="flex justify-between items-center mb-4">
                         <button id="back-to-calendar" class="text-stone-600 hover:text-stone-900 transition"><i class="fas fa-calendar-alt mr-2"></i>Back to Calendar</button>
                    </div>
                    <div class="flex-grow flex flex-col justify-center items-center text-center">
                        <h3 id="journal-date-left" class="text-2xl font-bold text-stone-800"></h3>
                        <p class="text-stone-500 mt-2">Your space to reflect and grow.</p>
                        
                        <div id="media-preview-display" class="w-full mt-4 p-4 bg-stone-50 rounded-lg hidden">
                            <p class="text-sm font-semibold text-stone-700 mb-2">Your Media</p>
                            <div class="grid grid-cols-2 gap-2" id="media-preview-grid"></div>
                        </div>

                        <div class="mt-8 space-y-3">
                            <!-- Hidden file input for direct image upload -->
                            <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                            <button id="add-image-upload-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center justify-center"><i class="fas fa-image mr-2"></i>Upload Image</button>
                            <button id="add-image-url-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center justify-center"><i class="fas fa-link mr-2"></i>Add Image from URL</button>
                            <button id="add-spotify-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition flex items-center justify-center"><i class="fab fa-spotify mr-2"></i>Add Spotify</button>
                        </div>
                    </div>
                     <div class="flex justify-between items-center mt-auto">
                        <button id="prev-day-btn" class="text-stone-600 hover:text-stone-900 transition"><i class="fas fa-arrow-left mr-2"></i>Previous Day</button>
                        <button id="next-day-btn" class="text-stone-600 hover:text-stone-900 transition">Next Day<i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                </div>
                
                <!-- Right Flipper Page -->
                <div class="page-flipper w-1/2 h-full absolute right-0 top-0">
                    <!-- Front of the right page -->
                    <div id="journal-content-front" class="page-front w-full h-full bg-white shadow-xl rounded-r-lg p-6 overflow-y-auto">
                        <!-- Content will be injected here -->
                    </div>
                    <!-- Back of the right page (for flip effect) -->
                    <div id="journal-content-back" class="page-back w-full h-full bg-white shadow-xl rounded-r-lg p-6 overflow-y-auto">
                        <!-- Content will be injected here for the next page -->
                    </div>
                </div>
            </div>
        </section>

    </div>
    
    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center hidden">
        <div class="relative p-5 border w-96 rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-body" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Media Modal -->
    <div id="media-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-backdrop" class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-md z-10 p-6 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="media-modal-title" class="text-xl font-semibold">Add Media</h3>
                <button id="close-media-modal-btn" class="text-stone-500 hover:text-stone-800">&times;</button>
            </div>
            <div>
                <label id="media-modal-label" for="media-modal-input" class="block text-sm font-medium text-stone-700 mb-1">URL</label>
                <input type="text" id="media-modal-input" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <p id="media-modal-description" class="text-xs text-stone-500 mt-1"></p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="media-modal-cancel-btn" class="px-4 py-2 bg-stone-200 text-stone-800 rounded-md hover:bg-stone-300 transition">Cancel</button>
                <button id="media-modal-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Add Media</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all duration-300">
        Journal saved successfully!
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md z-10 flex flex-col space-y-4">
            <h2 class="text-2xl font-bold text-gray-800">App Settings</h2>
            <!-- User Name Input -->
            <label class="block">
                <span class="text-gray-700 font-medium">Your Name:</span>
                <input type="text" id="name-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2" placeholder="Enter your name">
            </label>
            <!-- Hobbies Textarea -->
            <label class="block">
                <span class="text-gray-700 font-medium">Favorite Things (one per line):</span>
                <textarea id="hobbies-input" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2" placeholder="e.g., Reading books, Hiking, Cooking"></textarea>
            </label>
            <!-- Color Pickers -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <label class="color-picker-label">
                    <span class="text-gray-700">Background Color:</span>
                    <input type="color" id="bg-color-picker" class="w-8 h-8 rounded-full border-2 border-gray-300">
                </label>
                <label class="color-picker-label">
                    <span class="text-gray-700">Text Color:</span>
                    <input type="color" id="text-color-picker" class="w-8 h-8 rounded-full border-2 border-gray-300">
                </label>
                <label class="color-picker-label">
                    <span class="text-gray-700">Name Color:</span>
                    <input type="color" id="name-color-picker" class="w-8 h-8 rounded-full border-2 border-gray-300">
                </label>
                <label class="color-picker-label">
                    <span class="text-gray-700">List Color:</span>
                    <input type="color" id="list-color-picker" class="w-8 h-8 rounded-full border-2 border-gray-300">
                </label>
            </div>
            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-btn" class="px-6 py-2 border border-gray-300 text-gray-700 font-medium rounded-full hover:bg-gray-100 transition">
                    Cancel
                </button>
                <button id="save-btn" class="px-6 py-2 bg-green-500 text-white font-medium rounded-full shadow-md hover:bg-green-600 transition">
                    Save
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This code now dynamically uses the configuration provided by the environment it's running in.
            const firebaseConfig = {
              apiKey: "AIzaSyDorJ8R3Cga5KOJMTz4d6RobGl8kYwolnM",
              authDomain: "emergent-digital-journal-app.firebaseapp.com",
              projectId: "emergent-digital-journal-app",
              storageBucket: "emergent-digital-journal-app.firebasestorage.app",
              messagingSenderId: "606563065547",
              appId: "1:606563065547:web:ff1f71757bf32417c8454e",
              measurementId: "G-NBEM8EK3K4"
            };        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const GEMINI_API_KEY = ""; // The environment will handle the API key.

        let app, auth, db, userId;
        let currentDate = new Date();
        let journalDate = new Date();
        let journalDataCache = {};
        let currentJournalEntry = {}; // New state object to hold all data for the current day
        let currentModalType = '';
        let userSettings = {}; // Global variable to store user settings
        
        const LLM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
        
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const monthYearHeader = document.getElementById('month-year-header');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');

        const calendarView = document.getElementById('calendar-view');
        const journalView = document.getElementById('journal-view');
        const backToCalendarBtn = document.getElementById('back-to-calendar');
        const journalDateLeft = document.getElementById('journal-date-left');
        
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const pageFlipper = document.querySelector('.page-flipper');
        
        const mediaModal = document.getElementById('media-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const closeMediaModalBtn = document.getElementById('close-media-modal-btn');
        const mediaModalCancelBtn = document.getElementById('media-modal-cancel-btn');
        const mediaModalSaveBtn = document.getElementById('media-modal-save-btn');
        const mediaModalTitle = document.getElementById('media-modal-title');
        const mediaModalLabel = document.getElementById('media-modal-label');
        const mediaModalDescription = document.getElementById('media-modal-description');
        const mediaModalInput = document.getElementById('media-modal-input');
        
        const addImageUploadBtn = document.getElementById('add-image-upload-btn');
        const addImageUrlBtn = document.getElementById('add-image-url-btn');
        const addSpotifyBtn = document.getElementById('add-spotify-btn');
        const imageUploadInput = document.getElementById('image-upload-input'); // New reference for hidden input
        const mediaPreviewDisplay = document.getElementById('media-preview-display');
        const mediaPreviewGrid = document.getElementById('media-preview-grid');
        
        const toast = document.getElementById('toast');

        const categoryOptions = ['Habits', 'Book Learnings', 'Music Lyrics', 'Fun Facts'];

        // Settings Modal Elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const saveBtn = document.getElementById('save-btn');
        const nameInput = document.getElementById('name-input');
        const hobbiesInput = document.getElementById('hobbies-input');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const textColorPicker = document.getElementById('text-color-picker');
        const nameColorPicker = document.getElementById('name-color-picker');
        const listColorPicker = document.getElementById('list-color-picker');
        const infoBtn = document.getElementById('info-btn');

        // UI Elements to update
        const displayNameEl = document.getElementById('display-name');
        const hobbiesListEl = document.getElementById('hobbies-list');
        const hobbiesListContainerEl = document.getElementById('hobbies-list-container');
        const userNameEl = document.getElementById('user-name');

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            messageModal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-10');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYearHeader.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                calendarGrid.innerHTML += '<div></div>';
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                const date = new Date(year, month, i);
                const dateString = formatDate(date);
                
                dayEl.textContent = i;
                dayEl.dataset.date = dateString;
                dayEl.className = 'calendar-day p-2 md:p-4 text-center cursor-pointer rounded-lg border border-transparent';

                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    dayEl.classList.add('bg-indigo-500', 'text-white', 'font-bold');
                } else {
                    dayEl.classList.add('bg-stone-50', 'hover:border-indigo-300');
                }
                
                if (journalDataCache[dateString]) {
                    dayEl.classList.add('relative');
                    dayEl.innerHTML += '<span class="absolute bottom-1 right-1 h-2 w-2 bg-green-500 rounded-full"></span>';
                }

                dayEl.addEventListener('click', () => openJournal(date));
                calendarGrid.appendChild(dayEl);
            }
        }
        
        function createMediaElement(media, isPreview = false) {
            let content = '';
            
            if (media.type === 'image' || media.type === 'image-upload') {
                content = `<img src="${media.src}" class="rounded-lg object-cover w-full ${isPreview ? 'h-20' : 'h-48'}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e5e7eb/4b5563?text=Image+Not+Found';">`;
            } else if (media.type === 'spotify') {
                const spotifyUrl = media.src.match(/src="([^"]+)"/);
                if (spotifyUrl) {
                    content = `<iframe class="spotify-embed" src="${spotifyUrl[1]}" width="100%" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>`;
                }
            }
            
            const removeButton = `<button class="remove-media-btn absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">&times;</button>`;

            return `
                <div class="relative ${isPreview ? 'col-span-1' : 'col-span-1 md:col-span-2'}" data-media-type="${media.type}" data-media-src="${media.src}">
                    ${content}
                    ${removeButton}
                </div>
            `;
        }

        function renderMedia() {
            const mediaDisplay = document.getElementById('media-display');
            if (mediaDisplay) {
                mediaDisplay.innerHTML = currentJournalEntry.media.map(m => createMediaElement(m, false)).join('');
            }
            
            mediaPreviewGrid.innerHTML = currentJournalEntry.media.map(m => createMediaElement(m, true)).join('');
            
            if (currentJournalEntry.media.length > 0) {
                mediaPreviewDisplay.classList.remove('hidden');
            } else {
                mediaPreviewDisplay.classList.add('hidden');
            }

            // Attach event listeners to the new remove buttons
            document.querySelectorAll('.remove-media-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemEl = event.target.closest('[data-media-src]');
                    if (itemEl) {
                        const src = itemEl.dataset.mediaSrc;
                        currentJournalEntry.media = currentJournalEntry.media.filter(m => m.src !== src);
                        renderMedia();
                    }
                });
            });
        }
        
        function getCategoryContent(category, data = {}) {
            switch(category) {
                case 'Activities':
                    return `
                        <div class="flex-grow">
                            <label for="main-entry" class="block text-sm font-medium text-stone-700">Today's Thoughts</label>
                            <div class="flex items-center space-x-2 my-2">
                                <button id="fun-fact-btn" class="text-sm bg-gray-200 px-3 py-1 rounded-full hover:bg-gray-300 transition">Get Fun Fact ✨</button>
                                <button id="read-aloud-btn" class="text-sm bg-gray-200 px-3 py-1 rounded-full hover:bg-gray-300 transition">Read Aloud ✨</button>
                            </div>
                            <textarea id="main-entry" rows="8" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2 h-full">${data.mainEntry || ''}</textarea>
                        </div>
                    `;
                case 'English Practice Zone':
                    return `
                         <div class="border-t border-stone-200 pt-4 mt-8">
                            <h4 class="font-semibold text-lg text-stone-700 mb-2">English Practice Zone</h4>
                            <button id="grammar-coach-btn" class="text-sm bg-gray-200 px-3 py-1 rounded-full hover:bg-gray-300 transition mb-2">Grammar & Tense Coach ✨</button>
                            <div class="space-y-3">
                                <div>
                                    <label for="past-tense" class="block text-sm font-medium text-stone-600">Past Tense</label>
                                    <textarea id="past-tense" rows="3" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.pastTense || ''}</textarea>
                                </div>
                                <div>
                                    <label for="present-tense" class="block text-sm font-medium text-stone-600">Present Tense</label>
                                    <textarea id="present-tense" rows="3" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.presentTense || ''}</textarea>
                                </div>
                                <div>
                                    <label for="future-tense" class="block text-sm font-medium text-stone-600">Future Tense</label>
                                    <textarea id="future-tense" rows="3" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.futureTense || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                case 'Habits':
                    return `
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-sm text-stone-700 mb-2">My Daily Habits</h4>
                                <label class="flex items-center space-x-2 text-stone-600">
                                    <input type="checkbox" id="habit-read" class="rounded text-indigo-600 focus:ring-indigo-500" ${data.read ? 'checked' : ''}>
                                    <span>Read 10 pages</span>
                                </label>
                                <label class="flex items-center space-x-2 text-stone-600">
                                    <input type="checkbox" id="habit-exercise" class="rounded text-indigo-600 focus:ring-indigo-500" ${data.exercise ? 'checked' : ''}>
                                    <span>Exercise for 30 mins</span>
                                </label>
                            </div>
                            <div>
                                <label for="habits-notes" class="block text-sm font-medium text-stone-700">Notes on Habits</label>
                                <textarea id="habits-notes" rows="4" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.notes || ''}</textarea>
                            </div>
                        </div>
                    `;
                case 'Book Learnings':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label for="book-title" class="block text-sm font-medium text-stone-700">Book Title</label>
                                <input type="text" id="book-title" class="mt-1 block w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" value="${data.title || ''}">
                            </div>
                            <div>
                                <label for="book-takeaways" class="block text-sm font-medium text-stone-700">Key Takeaways</label>
                                <textarea id="book-takeaways" rows="6" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.takeaways || ''}</textarea>
                            </div>
                            <div>
                                <label for="book-quote" class="block text-sm font-medium text-stone-700">Favorite Quote</label>
                                <textarea id="book-quote" rows="3" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.quote || ''}</textarea>
                            </div>
                        </div>
                    `;
                case 'Music Lyrics':
                    return `
                        <div class="flex-grow">
                            <label for="music-lyrics" class="block text-sm font-medium text-stone-700">Your Favorite Lyrics</label>
                            <textarea id="music-lyrics" rows="10" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.lyrics || ''}</textarea>
                        </div>
                    `;
                case 'Fun Facts':
                    return `
                        <div class="flex-grow">
                            <label for="fun-facts" class="block text-sm font-medium text-stone-700">Random Fun Facts</label>
                            <textarea id="fun-facts" rows="10" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-stone-300 rounded-md p-2">${data.facts || ''}</textarea>
                        </div>
                    `;
            }
        }
        
        function createCategoryBlockHTML(category, data = {}) {
            const sanitizedCategory = category.replace(/\s+/g, '-').toLowerCase();
            return `
                <div id="category-${sanitizedCategory}-block" class="category-block" data-category="${category}">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-stone-800">${category}</h4>
                        <button class="remove-category-btn text-red-500 hover:text-red-700 transition">
                            <i class="fas fa-trash-alt"></i> Remove
                        </button>
                    </div>
                    ${getCategoryContent(category, data)}
                </div>
            `;
        }

        function createJournalPageHTML(date, data = {}) {
            const dateString = formatDate(date);
            const friendlyDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // This is the static, always-present content block for the main entry.
            const mainContent = `
                <div class="flex flex-col h-full journal-content" data-date="${dateString}">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-stone-800">${friendlyDate}</h3>
                        <button class="save-journal-btn bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save</button>
                    </div>

                    ${getCategoryContent('Activities', data.activities)}

                    <!-- Moved the media-display here as per the user's request. -->
                    <div id="media-display" class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4">
                        ${(data.media || []).map(m => createMediaElement(m, false)).join('')}
                    </div>

                    ${getCategoryContent('English Practice Zone', data.activities)}
                    
                    <!-- Category selection and add button -->
                    <div class="border-t border-stone-200 pt-4 mt-auto">
                        <h4 class="font-semibold text-lg text-stone-700 mb-2">Add More Categories</h4>
                        <div class="flex space-x-2">
                            <select id="category-select" class="flex-grow block w-full pl-3 pr-10 py-2 text-base border-stone-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                ${categoryOptions.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                            <button id="add-category-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition flex items-center justify-center">
                                <i class="fas fa-plus mr-2"></i>Add
                            </button>
                        </div>
                    </div>
                    
                    <!-- Container for dynamically added category blocks -->
                    <div id="dynamic-categories-container"></div>
                </div>
            `;
            return mainContent;
        }

        async function openJournal(date) {
            journalDate = new Date(date);
            const dateString = formatDate(journalDate);
            journalDateLeft.textContent = journalDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/journal_entries`, dateString);
            const docSnap = await getDoc(docRef);
            
            currentJournalEntry = docSnap.exists() ? docSnap.data() : { activities: {} };
            
            try {
                currentJournalEntry.media = docSnap.exists() && docSnap.data().media ? JSON.parse(docSnap.data().media) : [];
            } catch (e) {
                console.error("Failed to parse media data:", e);
                currentJournalEntry.media = [];
            }
            
            const journalHTML = createJournalPageHTML(journalDate, currentJournalEntry);
            document.getElementById('journal-content-front').innerHTML = journalHTML;

            // Render existing dynamic categories
            const dynamicContainer = document.getElementById('dynamic-categories-container');
            if(dynamicContainer) {
                dynamicContainer.innerHTML = ''; // Clear previous
                categoryOptions.forEach(category => {
                    const sanitizedKey = category.replace(/\s+/g, '').toLowerCase();
                    if (currentJournalEntry[sanitizedKey]) {
                        dynamicContainer.innerHTML += createCategoryBlockHTML(category, currentJournalEntry[sanitizedKey]);
                    }
                });
            }

            calendarView.classList.add('hidden');
            journalView.classList.remove('hidden');

            renderMedia();
            bindJournalEventListeners();
        }
        
        function bindJournalEventListeners() {
            document.querySelector('.save-journal-btn').addEventListener('click', saveJournal);

            const funFactBtn = document.getElementById('fun-fact-btn');
            if (funFactBtn) funFactBtn.addEventListener('click', getFunFact);

            const grammarCoachBtn = document.getElementById('grammar-coach-btn');
            if (grammarCoachBtn) grammarCoachBtn.addEventListener('click', getGrammarFeedback);

            const readAloudBtn = document.getElementById('read-aloud-btn');
            if (readAloudBtn) readAloudBtn.addEventListener('click', readAloud);
            
            // Logic for image upload
            addImageUploadBtn.addEventListener('click', () => imageUploadInput.click());
            imageUploadInput.addEventListener('change', handleImageUpload);
            
            // Logic for image from URL and Spotify
            addImageUrlBtn.addEventListener('click', () => openMediaModal('image'));
            addSpotifyBtn.addEventListener('click', () => openMediaModal('spotify'));
            
            const addCategoryBtn = document.getElementById('add-category-btn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', () => {
                    const select = document.getElementById('category-select');
                    const categoryToAdd = select.value;
                    const dynamicContainer = document.getElementById('dynamic-categories-container');
                    const sanitizedKey = categoryToAdd.replace(/\s+/g, '').toLowerCase();

                    if (!currentJournalEntry[sanitizedKey]) {
                        currentJournalEntry[sanitizedKey] = {};
                        dynamicContainer.innerHTML += createCategoryBlockHTML(categoryToAdd);
                        bindRemoveButtons();
                    } else {
                        Swal.fire('Category Exists', `${categoryToAdd} is already on the page.`, 'info');
                    }
                });
            }
            bindRemoveButtons();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                currentJournalEntry.media.push({ type: 'image-upload', src: e.target.result });
                renderMedia();
            };
            reader.readAsDataURL(file);
        }
        
        function bindRemoveButtons() {
            document.querySelectorAll('.remove-category-btn').forEach(btn => {
                // Remove existing listeners to prevent duplicates
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', (e) => {
                    const block = e.target.closest('.category-block');
                    const category = block.dataset.category;
                    const sanitizedKey = category.replace(/\s+/g, '').toLowerCase();
                    if (block) {
                        delete currentJournalEntry[sanitizedKey];
                        block.remove();
                    }
                });
            });
        }
        
        async function flipToDate(newDate, direction) {
            if (pageFlipper.classList.contains('flipped')) return;
            
            // Update the in-memory object before leaving the page
            updateCurrentEntryData();
            await saveJournal(); // Save current journal before flipping

            journalDate = newDate;
            const dateString = formatDate(journalDate);
            
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/journal_entries`, dateString);
            const docSnap = await getDoc(docRef);
            
            // Load the new day's data into the in-memory object
            currentJournalEntry = docSnap.exists() ? docSnap.data() : { activities: {} };
            
            try {
                currentJournalEntry.media = docSnap.exists() && docSnap.data().media ? JSON.parse(docSnap.data().media) : [];
            } catch (e) {
                console.error("Failed to parse media data:", e);
                currentJournalEntry.media = [];
            }
            
            const nextHTML = createJournalPageHTML(journalDate, currentJournalEntry);
            
            if (direction === 'forward') {
                pageFlipper.style.transformOrigin = 'left center';
                pageFlipper.classList.remove('flipped');
            } else {
                pageFlipper.style.transformOrigin = 'right center';
            }
            
            document.getElementById('journal-content-back').innerHTML = nextHTML;
            
            pageFlipper.classList.add('flipped');

            setTimeout(() => {
                journalDateLeft.textContent = journalDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                
                document.getElementById('journal-content-front').innerHTML = nextHTML;
                document.getElementById('journal-content-back').innerHTML = '';
                
                // Re-render the dynamic content
                const dynamicContainer = document.getElementById('dynamic-categories-container');
                 if(dynamicContainer) {
                    dynamicContainer.innerHTML = ''; // Clear previous
                    categoryOptions.forEach(category => {
                        const sanitizedKey = category.replace(/\s+/g, '').toLowerCase();
                        if (currentJournalEntry[sanitizedKey]) {
                            dynamicContainer.innerHTML += createCategoryBlockHTML(category, currentJournalEntry[sanitizedKey]);
                        }
                    });
                }

                pageFlipper.style.transition = 'none';
                pageFlipper.classList.remove('flipped');
                
                setTimeout(() => {
                    pageFlipper.style.transition = 'transform 0.8s';
                    renderMedia();
                    bindJournalEventListeners();
                }, 50);
            }, 800);
        }

        function updateCurrentEntryData() {
            // Update Activities
            const activitiesData = {
                mainEntry: document.getElementById('main-entry')?.value || '',
                pastTense: document.getElementById('past-tense')?.value || '',
                presentTense: document.getElementById('present-tense')?.value || '',
                futureTense: document.getElementById('future-tense')?.value || '',
            };
            currentJournalEntry.activities = activitiesData;

            // Update dynamically added categories
            document.querySelectorAll('#dynamic-categories-container .category-block').forEach(block => {
                const category = block.dataset.category;
                const sanitizedKey = category.replace(/\s+/g, '').toLowerCase();

                let categoryData = {};
                switch(category) {
                    case 'Habits':
                        categoryData = {
                            read: block.querySelector('#habit-read')?.checked || false,
                            exercise: block.querySelector('#habit-exercise')?.checked || false,
                            notes: block.querySelector('#habits-notes')?.value || ''
                        };
                        break;
                    case 'Book Learnings':
                        categoryData = {
                            title: block.querySelector('#book-title')?.value || '',
                            takeaways: block.querySelector('#book-takeaways')?.value || '',
                            quote: block.querySelector('#book-quote')?.value || ''
                        };
                        break;
                    case 'Music Lyrics':
                        categoryData = {
                            lyrics: block.querySelector('#music-lyrics')?.value || ''
                        };
                        break;
                    case 'Fun Facts':
                        categoryData = {
                            facts: block.querySelector('#fun-facts')?.value || ''
                        };
                        break;
                }
                currentJournalEntry[sanitizedKey] = categoryData;
            });
        }

        async function saveJournal() {
            const currentJournalEl = document.querySelector('.journal-content');
            if (!currentJournalEl) return;
            
            updateCurrentEntryData();
            
            const dataToSave = { ...currentJournalEntry };

            // Filter out large image-upload data to prevent the document size limit error
            const mediaToSave = currentJournalEntry.media.filter(m => m.type !== 'image-upload');
            if (mediaToSave.length < currentJournalEntry.media.length) {
                Swal.fire({
                    title: 'Upload Warning',
                    text: 'Uploaded images are not saved to the database due to size limits. They will disappear on refresh.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
            }

            dataToSave.media = JSON.stringify(mediaToSave);

            const dateString = currentJournalEl.dataset.date;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/journal_entries`, dateString);
            
            await setDoc(docRef, dataToSave);
            
            journalDataCache[dateString] = true;
            renderCalendar();
            showToast('Journal saved!');
        }

        function openMediaModal(type) {
            currentModalType = type;
            mediaModalInput.value = '';
            switch(type) {
                case 'image':
                    mediaModalTitle.textContent = 'Add Image from URL';
                    mediaModalLabel.textContent = 'Image URL';
                    mediaModalDescription.textContent = 'Paste the direct URL to the image here.';
                    break;
                case 'spotify':
                    mediaModalTitle.textContent = 'Add Spotify Song';
                    mediaModalLabel.textContent = 'Spotify Embed Code';
                    mediaModalDescription.textContent = 'From Spotify, click Share > Embed track and copy the code.';
                    break;
            }
            mediaModal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                mediaModal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }
        
        function closeMediaModal() {
            modalBackdrop.classList.add('opacity-0');
            mediaModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                mediaModal.classList.add('hidden');
            }, 300);
        }
        
        mediaModalSaveBtn.addEventListener('click', () => {
            const src = mediaModalInput.value;
            if (!src) return;

            if (currentModalType === 'image') {
                currentJournalEntry.media.push({ type: 'image', src });
            } else if (currentModalType === 'spotify') {
                currentJournalEntry.media.push({ type: 'spotify', src });
            }
            renderMedia();
            closeMediaModal();
        });

        async function callLLM(prompt, systemInstruction) {
            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000;
            
            while (retries < maxRetries) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    };
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error("API call failed: " + response.status);
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    retries++;
                    if (retries < maxRetries) {
                        const delay = initialDelay * Math.pow(2, retries - 1);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("LLM API failed after multiple retries:", error);
                        Swal.fire('LLM Error', 'Failed to communicate with the AI. Please try again.', 'error');
                        throw error;
                    }
                }
            }
        }
        
        async function getFunFact() {
            const entryText = document.getElementById('main-entry').value;
            const funFactBtn = document.getElementById('fun-fact-btn');
            
            if (!entryText) {
                Swal.fire({
                    title: 'No Text to Analyze',
                    text: 'Please write something in your journal entry first.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }

            funFactBtn.disabled = true;
            funFactBtn.textContent = 'Thinking...';
            
            const hobbies = userSettings.hobbies && userSettings.hobbies.length > 0 ? userSettings.hobbies.join(', ') : 'no favorite things';
            const systemPrompt = `You are a pop culture expert and a source of entertaining information. Based on the user's journal entry: "${entryText}", and their favorite things: ${hobbies}, provide a fun fact or an iconic quote from a series or movie that relates to the topic. The response should be a single, interesting statement. If no clear connection can be made, provide a generic but interesting fun fact.`;

            try {
                const fact = await callLLM(entryText, systemPrompt);
                Swal.fire({
                    title: 'Fun Fact!',
                    text: fact,
                    icon: 'info',
                    confirmButtonText: 'Cool!'
                });
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to generate a fun fact. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                funFactBtn.disabled = false;
                funFactBtn.textContent = 'Get Fun Fact ✨';
            }
        }

        async function getGrammarFeedback() {
            const pastText = document.getElementById('past-tense').value;
            const presentText = document.getElementById('present-tense').value;
            const futureText = document.getElementById('future-tense').value;
            const coachBtn = document.getElementById('grammar-coach-btn');
            
            if (!pastText && !presentText && !futureText) {
                Swal.fire({
                    title: 'No Text to Analyze',
                    text: 'Please write something in the English practice sections first.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            coachBtn.disabled = true;
            coachBtn.textContent = 'Thinking...';

            const fullText = `Past Tense: ${pastText}\n\nPresent Tense: ${presentText}\n\nFuture Tense: ${futureText}`;
            const systemPrompt = "You are an English language coach. Review the following text for grammar, tense, and vocabulary. Provide clear, concise, and constructive feedback and corrections. Use bullet points for easy reading.";
            
            try {
                const feedback = await callLLM(fullText, systemPrompt);
                Swal.fire({
                    title: 'Grammar Coach Feedback',
                    html: `<div class="text-left"><p>${feedback.replace(/\n/g, '</p><p>')}</p></div>`,
                    icon: 'info',
                    confirmButtonText: 'Great, thanks!'
                });
            } catch (error) {
                 Swal.fire({
                    title: 'Error',
                    text: 'Failed to get grammar feedback. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                coachBtn.disabled = false;
                coachBtn.textContent = 'Grammar & Tense Coach ✨';
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            
            const pcmBuffer = pcmData.buffer;
            const wavBuffer = new ArrayBuffer(44 + pcmBuffer.byteLength);
            const view = new DataView(wavBuffer);
            
            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmBuffer.byteLength, true);
            writeString(view, 8, 'WAVE');
            
            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true);
            
            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            
            new Uint8Array(wavBuffer, 44).set(new Uint8Array(pcmBuffer));
            
            return new Blob([wavBuffer], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function readAloud() {
            const entryText = document.getElementById('main-entry')?.value || '';
            const pastTense = document.getElementById('past-tense')?.value || '';
            const presentTense = document.getElementById('present-tense')?.value || '';
            const futureTense = document.getElementById('future-tense')?.value || '';
            const fullText = `Today's entry. ${entryText}. Past Tense. ${pastTense}. Present Tense. ${presentTense}. Future Tense. ${futureTense}.`;
            const readAloudBtn = document.getElementById('read-aloud-btn');

            if (!fullText) {
                showToast("Nothing to read aloud.");
                return;
            }

            readAloudBtn.disabled = true;
            readAloudBtn.textContent = 'Speaking...';
            
            try {
                const payload = {
                    contents: [{ parts: [{ text: fullText }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Iapetus" }
                            }
                        }
                    },
                };
                let retries = 0;
                const maxRetries = 3;
                const initialDelay = 1000;
                
                let response;
                while (retries < maxRetries) {
                    try {
                        response = await fetch(TTS_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                        throw new Error("TTS API call failed: " + response.status);
                    } catch (error) {
                        retries++;
                        if (retries < maxRetries) {
                            const delay = initialDelay * Math.pow(2, retries - 1);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw error;
                        }
                    }
                }
                
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    throw new Error("No audio data received.");
                }
            } catch (error) {
                console.error("Failed to read aloud:", error);
                showToast("Failed to read aloud. Please try again.");
            } finally {
                readAloudBtn.disabled = false;
                readAloudBtn.textContent = 'Read Aloud ✨';
            }
        }

        // --- Settings Functions ---
        function showSettingsModal() {
            settingsModal.style.display = 'flex';
        }

        function hideSettingsModal() {
            settingsModal.style.display = 'none';
        }

        async function saveSettings() {
            if (!db || !userId) {
                console.error("Firestore or User ID is not available.");
                return;
            }
            const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/customization`);
            const settings = {
                name: nameInput.value || "Guest",
                hobbies: hobbiesInput.value.split('\n').filter(item => item.trim() !== ''),
                bgColor: bgColorPicker.value,
                textColor: textColorPicker.value,
                nameColor: nameColorPicker.value,
                listColor: listColorPicker.value
            };
            try {
                await setDoc(settingsDocRef, settings);
                Swal.fire({
                    title: 'Saved!',
                    text: 'Your settings have been saved.',
                    icon: 'success',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                hideSettingsModal();
            } catch (error) {
                console.error("Error saving settings:", error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to save settings. Please try again.',
                    icon: 'error'
                });
            }
        }

        function updateUI(data) {
            userSettings = data;
            document.body.style.backgroundColor = data.bgColor || '#f3f4f6';
            document.body.style.color = data.textColor || '#111827';
            // Update the user name
            const currentName = data.name || "Guest";
            if (userNameEl) {
                userNameEl.innerHTML = `Hello, <span id="display-name" style="color:${data.nameColor || '#1f2937'};">${currentName}</span>!`;
            }
            // Update the hobbies list
            const hobbies = data.hobbies || [];
            if (hobbiesListContainerEl && hobbiesListEl) {
                hobbiesListEl.innerHTML = '';
                if (hobbies.length > 0) {
                     hobbiesListContainerEl.classList.remove('hidden');
                    hobbies.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        li.style.color = data.listColor || '#4b5563';
                        hobbiesListEl.appendChild(li);
                    });
                } else {
                     hobbiesListContainerEl.classList.add('hidden');
                }
            }
            // Populate the input fields in the modal
            nameInput.value = data.name || "";
            hobbiesInput.value = hobbies.join('\n');
            bgColorPicker.value = data.bgColor || '#f3f4f6';
            textColorPicker.value = data.textColor || '#111827';
            nameColorPicker.value = data.nameColor || '#1f2937';
            listColorPicker.value = data.listColor || '#4b5563';
        }

        function setupRealtimeSettingsListener() {
            if (!db || !userId) return;
            const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/customization`);
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    updateUI(docSnap.data());
                } else {
                    console.log("No settings found, using defaults.");
                    updateUI({
                        name: "Guest",
                        hobbies: [],
                        bgColor: '#f3f4f6',
                        textColor: '#111827',
                        nameColor: '#1f2937',
                        listColor: '#4b5563'
                    });
                }
            }, (error) => {
                console.error("Failed to listen for real-time updates:", error);
            });
        }

        function showGeminiReport() {
            Swal.fire({
                title: 'Gemini Integrations',
                html: `
                    <div class="text-left space-y-4">
                        <p class="text-sm">The journal's AI features are working as intended and add significant value to your experience. These integrations include:</p>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li><strong>Get Fun Fact:</strong> It can find an interesting fact or an iconic quote related to your journal entry.</li>
                            <li><strong>Grammar & Tense Coach:</strong> It effectively analyzes your writing and provides useful feedback for improving your English skills.</li>
                            <li><strong>Read Aloud:</strong> This feature successfully converts your journal entries into high-quality audio, offering a new way to interact with your reflections.</li>
                        </ul>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'OK',
                customClass: {
                    container: 'swal-container',
                    popup: 'swal-popup',
                    header: 'swal-header',
                    title: 'swal-title',
                    content: 'swal-content',
                    confirmButton: 'swal-confirm-button',
                },
                buttonsStyling: false,
                didRender: () => {
                    const confirmButton = Swal.getConfirmButton();
                    if (confirmButton) {
                        confirmButton.classList.add('bg-indigo-600', 'text-white', 'px-4', 'py-2', 'rounded-lg', 'hover:bg-indigo-700', 'transition');
                    }
                }
            });
        }
        
        async function init() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration object is empty.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        document.getElementById('user-info').classList.remove('hidden');
                        
                        setupRealtimeSettingsListener();
                        onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/journal_entries`), (snapshot) => {
                            snapshot.docChanges().forEach(change => {
                                journalDataCache[change.doc.id] = change.type !== 'removed';
                            });
                            renderCalendar();
                        });

                    } else {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                Swal.fire("Initialization Error", "Could not connect to Firebase. Please check your configuration and console for details. Error: " + error.message, "error");
            }
            
            renderCalendar();
        }
        
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        backToCalendarBtn.addEventListener('click', async () => {
            updateCurrentEntryData();
            await saveJournal();
            journalView.classList.add('hidden');
            calendarView.classList.remove('hidden');
        });
        
        prevDayBtn.addEventListener('click', async () => {
            const newDate = new Date(journalDate);
            newDate.setDate(newDate.getDate() - 1);
            flipToDate(newDate, 'backward');
        });

        nextDayBtn.addEventListener('click', async () => {
            const newDate = new Date(journalDate);
            newDate.setDate(newDate.getDate() + 1);
            flipToDate(newDate, 'forward');
        });
        
        addImageUrlBtn.addEventListener('click', () => openMediaModal('image'));
        addSpotifyBtn.addEventListener('click', () => openMediaModal('spotify'));
        
        modalBackdrop.addEventListener('click', closeMediaModal);
        closeMediaModalBtn.addEventListener('click', closeMediaModal);
        mediaModalCancelBtn.addEventListener('click', closeMediaModal);

        // Settings event listeners
        settingsBtn.addEventListener('click', showSettingsModal);
        cancelBtn.addEventListener('click', hideSettingsModal);
        saveBtn.addEventListener('click', saveSettings);
        infoBtn.addEventListener('click', showGeminiReport);

        init();
    </script>
</body>
</html>



