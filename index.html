<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergent</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }
        .bg-glass {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dark-mode {
            background-color: #111827;
        }
        .dark-mode .bg-glass {
            background-color: rgba(31, 41, 55, 0.7);
        }
        .calendar-day.selected {
            @apply ring-4 ring-blue-500 ring-offset-2 ring-offset-white dark:ring-offset-gray-900;
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <div id="app" class="flex flex-col items-center justify-center min-h-screen p-4 dark:bg-gray-900">
        <div class="w-full max-w-2xl bg-glass rounded-3xl shadow-xl p-6 md:p-10 border border-gray-200 dark:border-gray-700 dark:text-gray-200">

            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">Emergent</h1>
                <div class="flex items-center">
                    <button id="themeToggle" class="p-2 rounded-full transition-colors duration-200 hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg id="sunIcon" class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"></path>
                        </svg>
                        <svg id="moonIcon" class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    <div id="userIdDisplay" class="ml-4 text-xs font-semibold text-gray-500 dark:text-gray-400 truncate"></div>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 text-gray-800 dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div id="currentMonth" class="text-xl font-bold text-gray-800 dark:text-white"></div>
                    <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 text-gray-800 dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center text-sm md:text-base">
                    <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Sun</div>
                    <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Mon</div>
                    <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Tue</div>
                    <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Wed</div>
                    <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Thu</div>
                    <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Fri</div>
                    <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Sat</div>
                </div>
            </div>

            <!-- Journal Entry Input -->
            <div class="relative mb-6">
                <h2 id="entryDateHeading" class="text-xl font-bold mb-4 text-gray-800 dark:text-white"></h2>
                <textarea id="journalInput" class="w-full h-40 p-4 rounded-xl border border-gray-300 focus:ring-4 focus:ring-blue-300 focus:border-blue-500 outline-none transition-all resize-none dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Today's Thoughts
                
English Practice Zone"></textarea>
                <button id="saveButton" class="absolute bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">Save</button>
            </div>

            <!-- Entries List -->
            <div id="entriesContainer" class="space-y-4">
                <!-- Entries will be dynamically inserted here -->
            </div>
            
            <!-- Message Box -->
            <div id="messageBox" class="fixed inset-x-0 top-4 mx-auto w-fit text-white py-2 px-4 rounded-full shadow-lg transition-opacity duration-300 opacity-0 hidden">
                Entry saved successfully!
            </div>
        </div>
    </div>
    
    <!-- Modal for Edit/Delete -->
    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-xl p-6 md:p-8 w-full max-w-xl dark:bg-gray-800 dark:text-gray-200">
            <h2 class="text-2xl font-bold mb-4 dark:text-white">Edit Entry</h2>
            <textarea id="editInput" class="w-full h-40 p-4 rounded-xl border border-gray-300 focus:ring-4 focus:ring-blue-300 focus:border-blue-500 outline-none transition-all resize-none dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="closeModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full transition-colors">Cancel</button>
                <button id="saveEditBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition-colors">Save Changes</button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, where, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase
    let app, db, auth;
    let userId = null;
    let currentEntries = [];
    let selectedDate = new Date();
    selectedDate.setHours(0, 0, 0, 0);
    
    // DOM Elements
    const journalInput = document.getElementById('journalInput');
    const saveButton = document.getElementById('saveButton');
    const entriesContainer = document.getElementById('entriesContainer');
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = document.getElementById('sunIcon');
    const moonIcon = document.getElementById('moonIcon');
    const messageBox = document.getElementById('messageBox');
    const editModal = document.getElementById('editModal');
    const editInput = document.getElementById('editInput');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const saveEditBtn = document.getElementById('saveEditBtn');

    // Calendar Elements
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthEl = document.getElementById('currentMonth');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const entryDateHeading = document.getElementById('entryDateHeading');

    // Show Message
    function showMessage(msg, type = 'success') {
        messageBox.textContent = msg;
        if (type === 'success') {
            messageBox.style.backgroundColor = 'rgba(34, 197, 94, 0.9)'; // Tailwind green-500 with opacity
        } else {
            messageBox.style.backgroundColor = 'rgba(239, 68, 68, 0.9)'; // Tailwind red-500 with opacity
        }
        messageBox.classList.remove('hidden', 'opacity-0');
        messageBox.classList.add('opacity-100');
        setTimeout(() => {
            messageBox.classList.remove('opacity-100');
            messageBox.classList.add('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300);
        }, 3000);
    }
    
    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe();
                        if (user) {
                            userId = user.uid;
                            document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                            console.log("User signed in:", userId);
                            resolve();
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                userId = auth.currentUser.uid;
                                document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                                console.log("User signed in:", userId);
                                resolve();
                            } catch (error) {
                                console.error("Authentication failed:", error);
                                showMessage("Authentication failed. Check console for details.", 'error');
                                // Fallback to a random ID for unauthenticated use
                                userId = `anon-${crypto.randomUUID()}`;
                                document.getElementById('userIdDisplay').textContent = `User ID: ${userId} (Anon)`;
                                resolve();
                            }
                        }
                    });
                });
                renderCalendar(selectedDate);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Firebase initialization failed. See console.", 'error');
            }
        } else {
            console.error("Firebase config is missing. App will not function correctly.");
            showMessage("Firebase config missing. Check environment variables.", 'error');
            userId = `anon-${crypto.randomUUID()}`;
            document.getElementById('userIdDisplay').textContent = `User ID: ${userId} (Offline)`;
            renderCalendar(selectedDate);
        }
    }
    
    // Theme Toggle
    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
        document.documentElement.classList.add('dark');
        moonIcon.style.display = 'block';
        sunIcon.style.display = 'none';
    } else {
        document.documentElement.classList.remove('dark');
        sunIcon.style.display = 'block';
        moonIcon.style.display = 'none';
    }

    themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        sunIcon.style.display = isDark ? 'none' : 'block';
        moonIcon.style.display = isDark ? 'block' : 'none';
    });

    // Render entries
    function renderEntries() {
        entriesContainer.innerHTML = '';
        currentEntries.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()); // Sort by most recent
        currentEntries.forEach(entry => {
            const entryEl = document.createElement('div');
            entryEl.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col dark:bg-gray-800 dark:border-gray-700';
            entryEl.dataset.id = entry.id;

            const entryTextEl = document.createElement('div');
            entryTextEl.className = 'text-gray-800 dark:text-white mb-2 whitespace-pre-wrap';
            entryTextEl.textContent = entry.text;

            const entryDateEl = document.createElement('div');
            entryDateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
            entryDateEl.textContent = new Date(entry.createdAt.toDate()).toLocaleString();

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-end space-x-2';

            const editBtn = document.createElement('button');
            editBtn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-full text-sm transition-colors';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => openEditModal(entry));

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-full text-sm transition-colors';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => deleteEntry(entry.id));

            buttonContainer.appendChild(editBtn);
            buttonContainer.appendChild(deleteBtn);

            entryEl.appendChild(entryTextEl);
            entryEl.appendChild(entryDateEl);
            entryEl.appendChild(buttonContainer);
            entriesContainer.appendChild(entryEl);
        });
    }

    // Calendar Rendering
    function renderCalendar(date) {
        if (!db || !userId) {
            console.warn("Database or User ID not available for calendar render. Retrying...");
            setTimeout(() => renderCalendar(date), 1000);
            return;
        }

        const today = new Date();
        const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const startDate = new Date(startOfMonth);
        startDate.setDate(startOfMonth.getDate() - startOfMonth.getDay());
        const endDate = new Date(endOfMonth);
        endDate.setDate(endOfMonth.getDate() + (6 - endOfMonth.getDay()));

        currentMonthEl.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });
        calendarGrid.innerHTML = `
            <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Sun</div>
            <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Mon</div>
            <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Tue</div>
            <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Wed</div>
            <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Thu</div>
            <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Fri</div>
            <div class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400">Sat</div>
        `;
        entryDateHeading.textContent = `Entries for ${selectedDate.toLocaleDateString()}`;

        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dayEl = document.createElement('div');
            dayEl.textContent = currentDate.getDate();
            dayEl.className = `calendar-day p-2 rounded-xl cursor-pointer transition-colors duration-200 flex flex-col justify-center items-center h-12 md:h-16 relative`;
            
            const isToday = currentDate.toDateString() === today.toDateString();
            const isSelected = currentDate.toDateString() === selectedDate.toDateString();
            const isThisMonth = currentDate.getMonth() === date.getMonth();
            
            if (isThisMonth) {
                dayEl.classList.add('hover:bg-gray-200', 'dark:hover:bg-gray-700', 'text-gray-800', 'dark:text-white');
            } else {
                dayEl.classList.add('text-gray-400', 'cursor-not-allowed');
            }

            if (isToday) {
                dayEl.classList.add('font-bold', 'border-2', 'border-blue-500');
            }

            if (isSelected) {
                dayEl.classList.add('selected');
            }

            const dayToListen = new Date(currentDate);
            dayEl.addEventListener('click', () => {
                selectedDate = new Date(dayToListen);
                selectedDate.setHours(0, 0, 0, 0);
                renderCalendar(date);
                fetchEntriesForDate(selectedDate);
            });

            calendarGrid.appendChild(dayEl);
            currentDate.setDate(currentDate.getDate() + 1);
        }

        fetchEntriesForDate(selectedDate);
    }
    
    // Fetch entries for a specific date
    function fetchEntriesForDate(date) {
        if (!db || !userId) {
            console.warn("Database or User ID not available for fetching.");
            return;
        }

        const startOfDay = new Date(date);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(date);
        endOfDay.setHours(23, 59, 59, 999);

        entryDateHeading.textContent = `Entries for ${date.toLocaleDateString()}`;

        const q = query(
            collection(db, `artifacts/${appId}/users/${userId}/entries`),
            where("createdAt", ">=", startOfDay),
            where("createdAt", "<=", endOfDay)
        );

        onSnapshot(q, (snapshot) => {
            currentEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderEntries();
        }, (error) => {
            console.error("Error with snapshot listener:", error);
            showMessage("Error fetching entries. Check console.", 'error');
        });
    }

    // Navigation for calendar
    prevMonthBtn.addEventListener('click', () => {
        selectedDate.setMonth(selectedDate.getMonth() - 1);
        renderCalendar(selectedDate);
    });

    nextMonthBtn.addEventListener('click', () => {
        selectedDate.setMonth(selectedDate.getMonth() + 1);
        renderCalendar(selectedDate);
    });

    // Save Entry
    saveButton.addEventListener('click', async () => {
        const text = journalInput.value.trim();
        if (text === "") {
            showMessage("Entry cannot be empty!");
            return;
        }

        if (!db || !userId) {
            showMessage("App not ready. Please wait.", 'error');
            console.error("Save failed: Firebase not initialized or user not authenticated.");
            return;
        }

        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/entries`), {
                text: text,
                createdAt: selectedDate,
            });
            journalInput.value = '';
            showMessage("Entry saved!");
        } catch (e) {
            console.error("Error adding document: ", e);
            showMessage("Error saving entry. Check console for details.", 'error');
        }
    });

    // Open Edit Modal
    function openEditModal(entry) {
        editInput.value = entry.text;
        editModal.style.display = 'flex';
        saveEditBtn.dataset.id = entry.id;
    }

    // Close Edit Modal
    closeModalBtn.addEventListener('click', () => {
        editModal.style.display = 'none';
    });

    // Save Edited Entry
    saveEditBtn.addEventListener('click', async () => {
        const entryId = saveEditBtn.dataset.id;
        const newText = editInput.value.trim();
        if (newText === "") {
            showMessage("Edited entry cannot be empty!");
            return;
        }

        if (!db || !userId) {
            showMessage("App not ready. Please wait.", 'error');
            console.error("Save failed: Firebase not initialized or user not authenticated.");
            return;
        }

        try {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/entries`, entryId);
            await setDoc(docRef, { text: newText }, { merge: true });
            editModal.style.display = 'none';
            showMessage("Entry updated!");
        } catch (e) {
            console.error("Error updating document: ", e);
            showMessage("Error updating entry. Check console for details.", 'error');
        }
    });

    // Delete Entry
    async function deleteEntry(entryId) {
        if (!db || !userId) {
            showMessage("App not ready. Please wait.", 'error');
            console.error("Delete failed: Firebase not initialized or user not authenticated.");
            return;
        }
        
        // Cannot use `confirm()` in this environment, so we proceed with deletion directly.
        // A custom modal could be used here for confirmation in a real app.
        try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/entries`, entryId));
            showMessage("Entry deleted!");
        } catch (e) {
            console.error("Error removing document: ", e);
            showMessage("Error deleting entry. Check console for details.", 'error');
        }
    }

    // Initialize the app on page load
    window.onload = initializeFirebase;
    </script>
</body>
</html>
